import pandas as pd
from os import listdir
from os.path import isfile, join
import os
import glob
import pandas as pd
def merge_csv(path,path_to_save):
    os.chdir(path)
    extension = 'csv'
    all_filenames = [i for i in glob.glob('*.{}'.format(extension))]
    # combine all files in the list
    combined_csv = pd.concat([pd.read_csv(f) for f in all_filenames])
    # export to csv
    combined_csv.to_csv(path_to_save+"merged_file.csv", index=False, encoding='utf-8-sig')

path = "C:/Users/pc/Desktop/android_vulnerability_datasets/Reports/"

path_to_save = "C:\\Users\\pc\\Desktop\\android_vulnerability_datasets\\filtered_csv\\"

filenames = [f for f in listdir(path) if isfile(join(path, f))]

for file_to_open in filenames:
    file_to_pars = open(
        path+file_to_open, "r", encoding='utf-8')
    new = ''
    name_file = new.join(file_to_pars.name.rsplit("_", 1))

    name_file = file_to_pars.name.rsplit('_', 1)[0]
    name_file = name_file.replace("C:/Users/pc/Desktop/android_vulnerability_datasets/Reports/", "")
    csv_to_save = pd.DataFrame()
    for line in file_to_pars:
        if "[Critical]" in line or "[Warning]" in line:
            to_write = line.replace(":", "")
            splitted_string = to_write.split("]")
            splitted_string[0] = splitted_string[0].replace("[", "")
            if "<" in to_write:
                category = to_write.split(">")
                category[0] = category[0].split("]")
                category[0][1] = category[0][1].replace("<","")
                row = {"NameApplication": name_file.strip(), "Severity": splitted_string[0].strip(),
                       "Category": category[0][1].strip(), "Description": category[1].replace("<","").strip()}

            else:
                row = {"NameApplication": name_file.strip(), "Severity": splitted_string[0].strip(), "Category": "",
                   "Description": splitted_string[1].replace("<","").strip()}

            csv_to_save = csv_to_save.append(row, ignore_index=True)
            print(name_file)
    csv_to_save.to_csv(path_to_save+name_file+".csv", index=False)

path_merged_csv = "C:\\Users\\pc\\Desktop\\android_vulnerability_datasets\\final_csv_filtered\\"
merge_csv(path_to_save,path_merged_csv)
